<html>

<head>
    <style>
        #mapid {
            height: 700px;
            width: 700px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin="" />

    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q=="
        crossorigin=""></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.js'></script>
    <script src="Simplified_County_Boundaries.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <script src='dataObjects/countyClass.js'></script>
    <script src='townPolygons.js'></script>
    <script src='dataObjects/vermontObject.js'></script>


</head>

<body>
    <div id="bagsDiv"></div>
    <div id="teamsDiv"></div>
    <div id="profilesDiv"></div>
    <div id="mapid"></div>





    <script>

        //these are the variables that point to useful numbers
        let totalBagsDropped;
        let totalTeams;
        let totalProfiles;

        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAjwSCpOvLPgYcFr26V3gmfwJlGb-VtWAs",
            authDomain: "greenupvermont-de02b.firebaseapp.com",
            databaseURL: "https://greenupvermont-de02b.firebaseio.com",
            projectId: "greenupvermont-de02b",
            storageBucket: "greenupvermont-de02b.appspot.com",
            messagingSenderId: "439621369113"
        };
        const email = "WillyNillyLoman@gmail.com"
        const password = "burlingtonCA"

        firebase.initializeApp(config);
        var database = firebase.database();

        firebase.auth().signInWithEmailAndPassword(email, password).catch(function (error) {
            // ToDo: handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // ...
        });
        let vermont = new Vermont
        // function buildCountyBagsArrays() {
        //   console.log('trash populate start')
        //   var trashDrops = firebase
        //     .database()
        //     .ref('trashDrops/')
        //     .on('value', function (snapshot) {
        //       trashDropsObject = snapshot.val()
        //       console.log('data retrieved')
        //       for (let county in vermont.counties) {
        //         vermont.counties[county].bagDrops = Array(0)
        //       }
        //       for (var key in trashDropsObject) {
        //         let countyBoundaries = L.geoJSON(countyPolygons);
        //         // put the coordinates of the trash drop object into a conveinient form
        //         let keyCoordinates = [trashDropsObject[key].location.longitude, trashDropsObject[key].location.latitude]
        //        // figure out which county the point is in, then cleans up that county name so it's usable in the next function
        //         var resultsArray = leafletPip.pointInLayer(keyCoordinates, countyBoundaries, true)
        //         var results = resultsArray[0].feature.properties.CNTYNAME.toLowerCase()
        //         //looks through the list of counties in our vermont object, finds the one whose name matches the one the trash drop is in. Then pushes the trash drop into an array in that county object.
        //         for(let county in vermont.counties){
        //           if(results === vermont.counties[county].name){
        //             vermont.counties[county].bagDrops.push(trashDropsObject[key])
        //           }            
        //         }
        //       }
        //       //to do: calculateTownBagCount
        //       //to do: calculateCountyBagCount
        //       console.log('populate finished.')
        //       console.log(vermont)
        //     })
        // }

        // buildCountyBagsArrays();

        var mymap = L.map('mapid').setView([44.0423, -72.6034], 8);
        L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 19,
            id: 'mapbox.streets',
        }).addTo(mymap);

        let countyBoundaries = L.geoJSON(countyPolygons);
        countyBoundaries.addTo(mymap)

        function putBagNumbersInPolygonData() {
            //inserts that data into the polygon objects.
            let counties = countyPolygons.features
            for (let countyIndex in counties) {
                counties[countyIndex].properties.bagCount = bagCountOf(counties[countyIndex].properties.CNTYNAME.toString().toLowerCase())
            }
            L.geoJson(countyPolygons, { style: style }).addTo(mymap);
        }
        //toDo: make something like the above, but for teams.


        function bagCountOf(county) {
            return vermont.counties[county].stats.bagCount
        }

        // each of the counties in countyBoundaries already has a bounding box, addisons is at the variable below.
        // this would make zooming easy when we get around to that.
        mymap.fitBounds(countyBoundaries._layers['51']._bounds)

        function getColor(d) {
            return d > 13 ? '#800026' :
                d > 11 ? '#BD0026' :
                    d > 9 ? '#E31A1C' :
                        d > 7 ? '#FC4E2A' :
                            d > 5 ? '#FD8D3C' :
                                d > 3 ? '#FEB24C' :
                                    d > 1 ? '#FED976' :
                                        '#FFEDA0';
        }

        function style(feature) {
            console.log(feature)
            return {
                fillColor: getColor(feature.properties.bagCount),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        

    </script>

</body>

</html>